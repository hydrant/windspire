# Backend Image Build Only
#
# This workflow ONLY builds and pushes the Docker image to GHCR.
# It does NOT deploy to Container Apps.
#
# Use this workflow to build the image before infrastructure deployment.

name: Build Backend Image

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment context (for caching)'
        required: false
        type: string
        default: 'dev'

env:
  CARGO_TERM_COLOR: always
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    name: Build & Push Container Image
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Verify SQLx offline mode before building Docker image
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev postgresql-client
          cargo install sqlx-cli --no-default-features --features postgres

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            windspire_backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('windspire_backend/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # Set up PostgreSQL for SQLx cache verification
      - name: Start PostgreSQL
        run: |
          docker run -d \
            --name postgres \
            -e POSTGRES_PASSWORD=test_password \
            -e POSTGRES_USER=test_user \
            -e POSTGRES_DB=windspire \
            -p 5432:5432 \
            postgres:16
          
          # Wait for PostgreSQL to be ready
          for i in {1..30}; do
            if docker exec postgres pg_isready -U test_user; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done

      # Generate SQLx query cache for offline mode (if not committed)
      - name: Generate SQLx query cache
        working-directory: windspire_backend
        run: |
          export DATABASE_URL="postgresql://test_user:test_password@localhost:5432/windspire"
          
          # Run migrations
          echo "üîÑ Running database migrations..."
          sqlx migrate run
          
          # Generate SQLx query cache (creates .sqlx directory if missing)
          echo "üîç Generating SQLx query cache..."
          if [ -d ".sqlx" ]; then
            echo "‚ÑπÔ∏è  .sqlx cache already exists (committed to repo)"
            cargo sqlx prepare --check || cargo sqlx prepare
          else
            echo "‚ö†Ô∏è  .sqlx cache missing - generating it now"
            cargo sqlx prepare
            echo "üí° TIP: Commit .sqlx directory to speed up future builds"
          fi
          
          echo "‚úÖ SQLx query cache ready - proceeding with Docker build"
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/windspire

      - name: Verify SQLx cache exists
        working-directory: windspire_backend
        run: |
          echo "üìÇ Checking .sqlx directory..."
          if [ -d ".sqlx" ]; then
            echo "‚úÖ .sqlx directory found"
            echo "üìä Query cache files:"
            ls -lh .sqlx/
          else
            echo "‚ùå ERROR: .sqlx directory not found!"
            exit 1
          fi

      - name: Clean up PostgreSQL
        if: always()
        run: |
          docker stop postgres || true
          docker rm postgres || true

      # Login to GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Set up Docker Buildx for multi-platform builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build and push to GitHub Container Registry
      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v6
        with:
          context: ./windspire_backend
          file: ./windspire_backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/windspire-backend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ github.repository_owner }}/windspire-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Image pushed successfully
        run: |
          echo "‚úÖ Docker image built and pushed to GitHub Container Registry"
          echo "üì¶ Image: ghcr.io/${{ github.repository_owner }}/windspire-backend:${{ env.IMAGE_TAG }}"
          echo "üì¶ Image: ghcr.io/${{ github.repository_owner }}/windspire-backend:latest"
          echo ""
          echo "üéØ Image is ready for infrastructure deployment!"
