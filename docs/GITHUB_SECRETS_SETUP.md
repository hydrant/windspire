# GitHub Secrets and Environment Variables Setup

This document outlines all the secrets and environment variables required for the CI/CD pipelines to work correctly.

## Required GitHub Secrets

### Azure Authentication
Set these up for infrastructure deployment and Azure Static Web Apps:

```bash
AZURE_CLIENT_ID         # Azure Service Principal Client ID
AZURE_TENANT_ID         # Azure Tenant ID  
AZURE_SUBSCRIPTION_ID   # Azure Subscription ID
AZURE_RESOURCE_GROUP    # Resource Group name for deployments
```

### Database Configuration
```bash
DATABASE_URL                    # PostgreSQL connection string
POSTGRES_ADMIN_LOGIN           # PostgreSQL admin username
POSTGRES_ADMIN_PASSWORD        # PostgreSQL admin password
```

### Firebase Configuration
```bash
FIREBASE_PROJECT_ID            # Firebase project ID
FIREBASE_PRIVATE_KEY          # Firebase service account private key
FIREBASE_CLIENT_EMAIL         # Firebase service account email
VITE_FIREBASE_CONFIG          # Frontend Firebase config (public)
FIREBASE_CONFIG               # Complete Firebase config object (JSON)
```

### CORS Configuration
```bash
CORS_ALLOWED_ORIGINS          # Comma-separated list of allowed origins
```

### Deployment Tokens
```bash
AZURE_STATIC_WEB_APPS_API_TOKEN  # Auto-generated by infrastructure deployment
GITHUB_TOKEN                     # Automatically provided by GitHub Actions
```

## Setup Instructions

### 1. Azure Service Principal Setup

Create a service principal for GitHub Actions:

```bash
# Login to Azure
az login

# Create service principal
az ad sp create-for-rbac \
  --name "windspire-github-actions" \
  --role contributor \
  --scopes /subscriptions/{subscription-id}/resourceGroups/{resource-group} \
  --sdk-auth
```

From the output, set these GitHub secrets:
- `AZURE_CLIENT_ID`: The `clientId` value
- `AZURE_TENANT_ID`: The `tenantId` value  
- `AZURE_SUBSCRIPTION_ID`: The `subscriptionId` value

### 2. Database Secrets

```bash
# Set PostgreSQL credentials
gh secret set POSTGRES_ADMIN_LOGIN --body "windspire_admin"
gh secret set POSTGRES_ADMIN_PASSWORD --body "your-secure-password"

# After infrastructure deployment, get the database URL:
# postgresql://windspire_admin:password@server.postgres.database.azure.com:5432/windspire?sslmode=require
gh secret set DATABASE_URL --body "postgresql://..."
```

### 3. Firebase Setup

Download your Firebase service account key and extract the values:

```bash
# From your Firebase service account JSON
gh secret set FIREBASE_PROJECT_ID --body "your-project-id"
gh secret set FIREBASE_CLIENT_EMAIL --body "firebase-adminsdk-xxxxx@your-project.iam.gserviceaccount.com"
gh secret set FIREBASE_PRIVATE_KEY --body "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"

# For frontend (public config)
gh secret set VITE_FIREBASE_CONFIG --body '{
  "apiKey": "...",
  "authDomain": "...",
  "projectId": "...",
  "storageBucket": "...",
  "messagingSenderId": "...",
  "appId": "..."
}'

# Complete config for infrastructure
gh secret set FIREBASE_CONFIG --body '{
  "projectId": "your-project-id",
  "privateKey": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  "clientEmail": "firebase-adminsdk-xxxxx@your-project.iam.gserviceaccount.com"
}'
```

### 4. CORS Configuration

```bash
# Set allowed origins (will be updated by infrastructure deployment)
gh secret set CORS_ALLOWED_ORIGINS --body "http://localhost:3000,http://localhost:5173"
```

### 5. Resource Group

```bash
# Set the Azure resource group name
gh secret set AZURE_RESOURCE_GROUP --body "windspire-rg"
```

## Environment Variables in Code

### Backend (.env file for local development)
```env
DATABASE_URL=postgresql://user:password@localhost:5432/windspire
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@your-project.iam.gserviceaccount.com
RUST_LOG=debug
FUNCTIONS_CUSTOMHANDLER_PORT=8080
```

### Frontend (.env file for local development)
```env
VITE_API_BASE_URL=http://localhost:8080/api
VITE_FIREBASE_CONFIG={
  "apiKey": "...",
  "authDomain": "...",
  "projectId": "...",
  "storageBucket": "...",
  "messagingSenderId": "...",
  "appId": "..."
}
```

## Deployment Flow

1. **Infrastructure Deployment** (`infrastructure.yml`):
   - Validates and deploys Azure resources
   - Creates Static Web App and gets deployment token
   - Updates GitHub secrets automatically

2. **Backend CI/CD** (`backend-ci-cd.yml`):
   - Runs tests, linting, and security audits
   - Generates code coverage reports

3. **Full Deployment** (`azure-static-web-apps-ci-cd.yml`):
   - Builds frontend and backend
   - Runs database migrations
   - Deploys to Azure Static Web Apps

## Security Notes

- All sensitive values are stored in GitHub Secrets or Azure Key Vault
- Database passwords use Azure Key Vault references in production
- Firebase private keys are properly escaped with newlines
- CORS origins are environment-specific and automatically updated

## Verification

After setup, verify your secrets are configured:

```bash
# List all secrets (values are hidden)
gh secret list

# Test the infrastructure deployment
gh workflow run infrastructure.yml
```