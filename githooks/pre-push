#!/bin/bash

# Check if we're in the right directory
if [ ! -f "setup-hooks.sh" ]; then
    echo "Error: Must be run from the root of the windspire repository"
    exit 1
fi

echo "ğŸ” Running pre-push checks..."

# Check backend (if windspire_backend directory exists)
if [ -d "windspire_backend" ]; then
    echo "ğŸ¦€ Checking Rust backend..."
    cd windspire_backend
    
    # Run cargo check
    cargo check
    if [ $? -ne 0 ]; then
        echo "âŒ Backend build check failed. Please fix the errors before pushing."
        exit 1
    fi
    
    # Run clippy with strict warnings
    cargo clippy --all-targets --all-features -- -D warnings
    if [ $? -ne 0 ]; then
        echo "âŒ Backend clippy check failed. Please fix the warnings before pushing."
        exit 1
    fi
    
    # Run tests
    cargo audit
    if [ $? -ne 0 ]; then
        echo "âŒ Backend cargo audit failed. Please fix vurlnerabilities before pushing."
        exit 1
    fi

    # Run tests
    cargo test
    if [ $? -ne 0 ]; then
        echo "âŒ Backend tests failed. Please fix the failing tests before pushing."
        exit 1
    fi

    cd ..
    echo "âœ… Backend checks passed"
fi

# Check CSR frontend (if windspire_frontend_svelte_csr directory exists)
if [ -d "windspire_frontend_svelte_csr" ]; then
    echo "ğŸ”§ Checking CSR Svelte frontend..."
    cd windspire_frontend_svelte_csr
    
    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo "âš ï¸  Installing CSR frontend dependencies..."
        npm install
    fi
    
    # Run linting (includes prettier check and eslint)
    npm run lint
    if [ $? -ne 0 ]; then
        echo "âŒ CSR Frontend linting failed. Run 'npm run format' to fix formatting issues."
        exit 1
    fi
    
    # Run build to check for compilation errors
    npm run build
    if [ $? -ne 0 ]; then
        echo "âŒ CSR Frontend build failed. Please fix the compilation errors before pushing."
        exit 1
    fi
    
    cd ..
    echo "âœ… CSR Frontend checks passed"
fi

echo "ğŸ‰ All pre-push checks passed. Proceeding with push."
exit 0